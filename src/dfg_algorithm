from cfg.staticfg.builder import CFGBuilder
import graphviz as gv
import ast
from cfg.staticfg.builder import CFGBuilder
from cfg.ast_utils import ASTUtils

path = '/Users/PatrickMcEwen/high_level_synthesis/venv/codesign/src/cfg/benchmarks/'
benchmark = 'example'
op_to_symbol = {
    'Mult': '*',
    'Add': '+',
    'Sub': '-',
    'FloorDiv': '/',
}
# format: node -> [symbol, id, write (true) or read (false)]
node_to_symbols = {}

class symbol:
    def __init__(self, value: str, num_id: str, write: bool):
        self.value = value
        self.num_id = num_id
        self.write = write

def process_operand(graph, cur_id, operand, operand_num, operation_num, node):
    if type(operand) == ast.Name:
        graph.node(operand_num, operand.id + '\nread')
        node_to_symbols[node].append(symbol(operand.id, operand_num, False))
        graph.edge(operand_num, operation_num)
    elif type(operand) == ast.BinOp:
        cur_id += 3
        cur_id = eval_single_op(operand, graph, cur_id, operation_num, [str(cur_id-2), str(cur_id-1)], str(cur_id-3), node)
    else: #dealing with ast.Constant
        graph.node(operand_num, str(operand.value))
        graph.edge(operand_num, operation_num)
    return cur_id


def eval_single_op(expr, graph, cur_id, target_id, value_ids, op_id, node):
    global op_to_symbol, node_to_symbols
    sub_values = ASTUtils.get_sub_expr(expr)
    print(sub_values)
    graph.node(op_id, op_to_symbol[ASTUtils.operator_to_opname(sub_values[1])])
    cur_id = process_operand(graph, cur_id, sub_values[0], value_ids[0], op_id, node)
    cur_id = process_operand(graph, cur_id, sub_values[2], value_ids[1], op_id, node)
    graph.edge(op_id, target_id)
    return cur_id


def eval_expr(expr, graph, cur_id, node):
    if type(expr) != ast.Assign and type(expr) != ast.AugAssign: return cur_id
    target = None
    if type(expr) == ast.Assign: target = expr.targets[0]
    elif type(expr) == ast.AugAssign: target = expr.target
    target_id = str(cur_id)
    graph.node(target_id, target.id + '\nwrite')
    cur_id += 1
    op_id = str(cur_id)
    cur_id += 1
    value_ids = [str(cur_id), str(cur_id + 1)]
    cur_id += 2
    if type(expr) == ast.Assign:
        #still have to add support for multiple assignments
        if type(expr.value) == ast.BinOp:
            cur_id = eval_single_op(expr.value, graph, cur_id, target_id, value_ids, op_id, node)
    elif type(expr) == ast.AugAssign:
        cur_id = eval_single_op(ast.BinOp(expr.target, expr.op, expr.value), graph, cur_id, target_id, value_ids, op_id, node)
    node_to_symbols[node].append(symbol(target.id, target_id, True))
    return cur_id


# first pass over the basic block
def dfg_per_node(node):
    graph = gv.Digraph()
    cur_id = 0
    for expr in node.statements:
        cur_id = eval_expr(expr, graph, cur_id, node)
    # walk backwards over statements, link reads to previous writes
    i = len(node_to_symbols[node])-1
    while i >= 0:
        if not node_to_symbols[node][i].write:
            j = i-1
            while j >= 0:
                if node_to_symbols[node][j].write and (node_to_symbols[node][j].value == node_to_symbols[node][i].value):
                    graph.edge(node_to_symbols[node][j].num_id, node_to_symbols[node][i].num_id)
                    break
                j -= 1
        i -= 1
    graph.render(path + 'pictures/' + benchmark + "_dfg_", view = True, format='jpeg')
    return 0



def main():
    global path, benchmark, node_to_symbols
    cfg = CFGBuilder().build_from_file('main.c', path + 'nonai_models/' + benchmark + '.py')
    cfg.build_visual(path + 'pictures/' + benchmark, 'jpeg', show = True)
    for node in cfg:
        node_to_symbols[node] = []
        dfg_per_node(node)
    return 0

if __name__ == "__main__":
    main()
